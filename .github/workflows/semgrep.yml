# name: Semgrep Security Scan

# on:
#   push:
#     branches: [main, develop]
#   pull_request:
#     branches: [main]

# jobs:
#   semgrep:
#     name: Semgrep Scan
#     runs-on: ubuntu-latest

#     steps:
#       - uses: actions/checkout@v4

#       # Install Semgrep
#       - name: Install Semgrep
#         run: |
#           pip install semgrep

#       # Run Semgrep (connect to Dashboard)
#       - name: Run Semgrep
#         run: |
#           semgrep \
#             --config=auto \
#             --sarif \
#             --output=semgrep.sarif \
#             src/
#         env:
#           SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}

#       # Upload SARIF to GitHub Code Scanning
#       - name: Upload SARIF file
#         uses: github/codeql-action/upload-sarif@v3
#         with:
#           sarif_file: semgrep.sarif
#         if: always()
name: Semgrep Scan

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]

jobs:
  semgrep:
    runs-on: ubuntu-latest
    steps:
      # 1️⃣ Checkout code
      - uses: actions/checkout@v4

      # 2️⃣ ติดตั้ง Semgrep CLI
      - name: Install Semgrep
        run: pip install semgrep

      # 3️⃣ Run Semgrep scan และ publish ขึ้น Dashboard
      - name: Run Semgrep
        env:
          SEMGREP_APP_TOKEN: ${{ secrets.SEMGREP_APP_TOKEN }}
        run: |
          semgrep --config p/ci \
                  --publish \
                  --branch ${{ github.ref_name }} \
                  --token $SEMGREP_APP_TOKEN

      # 4️⃣ Generate SARIF artifact (optional)
      - name: Generate SARIF
        run: semgrep --config p/ci --sarif --output semgrep.sarif

      # 5️⃣ Upload SARIF artifact
      - uses: actions/upload-artifact@v4
        with:
          name: semgrep-sarif
          path: semgrep.sarif
